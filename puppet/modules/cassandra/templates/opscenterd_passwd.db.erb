<%
require 'facter'
require 'digest'

password = Digest::SHA256.new.hexdigest(Facter.value('cassandra_cql_password'))
-%>
CREATE TABLE IF NOT EXISTS version(version_number TEXT PRIMARY KEY, migrated_at TEXT);
CREATE TABLE IF NOT EXISTS user_groups(groupid INTEGER PRIMARY KEY, groupname TEXT,UNIQUE(groupname));
CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username TEXT, password TEXT, groupid INTEGER, UNIQUE(username), FOREIGN KEY (groupid) references user_groups(groupid));
CREATE TABLE IF NOT EXISTS permissions(groupid INTEGER,permissions TEXT,clusterid TEXT,FOREIGN KEY (groupid) references user_groups(groupid));

INSERT OR IGNORE INTO permissions (groupid, permissions, clusterid) VALUES(1, '340282366920938463463374607431768211455', 'ALL_CLUSTER_PERMISSIONS');
INSERT OR IGNORE INTO user_groups (groupid, groupname) VALUES (1, 'admin');
INSERT OR IGNORE INTO users (username, groupid) VALUES ('admin', 1);
UPDATE users SET password='<%= password %>' where username='admin';
INSERT OR IGNORE INTO version (version_number, migrated_at) VALUES ('5.0.0', '1426214233.91588');
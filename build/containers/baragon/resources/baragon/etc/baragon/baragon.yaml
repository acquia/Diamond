# This file contains static configuration for baragon agents
# These are meant to be reasonable defaults shared by ALL baragon agents
# All of these options can be overridden at launch time with flags
# See ./baragon-start.sh
server:
  type: simple
  applicationContextPath: /baragon/v2
  connector:
    type: http
    port: 8882

logging:
  level: DEBUG

zookeeper:
  quorum: 127.0.0.1:2181
  zkNamespace: baragon
  sessionTimeoutMillis: 60000
  connectTimeoutMillis: 5000
  retryBaseSleepTimeMilliseconds: 1000
  retryMaxTries: 3

loadBalancerConfig:
  name: loadBalancerGroupName
  rootPath: /etc/nginx/conf.d
  checkConfigCommand: /usr/sbin/nginx -t
  reloadConfigCommand: /usr/sbin/nginx -s reload

# These templates enable tcp support
templates:
  - filename: proxy/%s.conf
    template: |
      # This configuration is automatically generated by Baragon, local changes may be lost!
      #
      # Service ID: {{{service.serviceId}}}
      # Service base path: {{{service.serviceBasePath}}}
      # Owners:
      {{#each service.owners}}
      #   - {{{.}}}
      {{else}}
      #   No owners!
      {{/each}}
      {{#if upstreams}}
      {{#if service.options.nginxExtraConfigs}}
      # BEGIN CUSTOM NGINX CONFIGS
      {{#each service.options.nginxExtraConfigs}}{{{.}}}
      {{/each}}
      # END CUSTOM NGINX CONFIGS
      {{/if}}
      server {
          {{#if agentProperties.extraAgentData.port}}
          listen {{{agentProperties.extraAgentData.port}}};
          {{/if}}
          {{#if service.options.nginxProxyPassOverride}}
          proxy_pass {{{service.options.nginxProxyPassOverride}}};
          {{else}}
          proxy_pass baragon_{{{service.serviceId}}};
          {{/if}}
      }
      {{else}}
      #
      # Service is disabled due to no defined upstreams!
      # It's safe to delete this file if not needed.
      #
      {{/if}}

  - filename: upstreams/%s.conf
    template: |
      # This configuration is automatically generated by Baragon, local changes may be lost!
      #
      # Service ID: {{{service.serviceId}}}
      # Service base path: {{{service.serviceBasePath}}}
      # Owners:
      {{#each service.owners}}
      #   - {{{.}}}
      {{else}}
      #   No owners!
      {{/each}}
      {{#if upstreams}}
      upstream baragon_{{{service.serviceId}}} {
          {{#each upstreams}}server {{{upstream}}};  # {{{requestId}}}
          {{/each}}
          {{#if service.options.nginxExtraUpstreamConfigs}}
          # BEGIN CUSTOM NGINX UPSTREAM CONFIGS
          {{#each service.options.nginxExtraUpstreamConfigs}}{{{.}}}
          {{/each}}
          # END CUSTOM NGINX UPSTREAM CONFIGS
          {{/if}}
      }
      {{else}}
      #
      # Service is disabled due to no defined upstreams!
      # It's safe to delete this file if not needed.
      #
      {{/if}}
